## Topological data analysis

#### Dependencies

*Install the following libraries before running the TDA pipeline.*

```{r}
install.packages(c("TDA", "Matrix"))
```
-----------

## Load libraries

```{r}
library("Matrix") # package for sparse matrices
library("TDA")
```

## Set working directory

```{r}
working_dir_path <- "~/Documents/GitHub/TDA-Microscopy-Pipeline/TDA/general-pipeline"
```

## Functions

```{r}
# get helper functions
source("utilities.R")
```

## Create a folder with subfolders for two data groups for storing saved tda computations
*You only need to run this block once*

```{r, include=FALSE}
dir.create("saved_computations")
saved_computations <- concat_path(working_dir_path, "saved_computations")

#choose names for two data groups
groups <- list("group_1", "group_2")

for (i in 1:length(groups)){
  dir.create(concat_path(saved_computations,groups[i]))
}
```

## Create a single csv file for storing some necessary parameters (max birth and max death) obtained from all data groups

```{r}
max_values <- data.frame(matrix(ncol = 2, nrow = 0))
colnames(max_values) <- c("maxbirth", "maxdeath")  

write.csv(max_values, concat_path(saved_computations,"max-values.csv"), row.names=FALSE)
```

## Choose cell types

```{r}
#specify location path of the file with the cell type codes and their colors
cell_types_path <- "~/Documents/GitHub/TDA-Microscopy-Pipeline/Discretization/cell_colors.csv"

cell_types_file <- read.csv(cell_types_path)
all_cell_types <- cell_types_file$Code

#pick a cell type or a union of cell types to which apply TDA pipeline
cell_types <- all_cell_types[3]

print("Cell types used:")
print(cell_types)
```

## Choose a data group and its location 

```{r}
#choose a group folder where to save computations
group <- "group_2"

# specify location path of the csv files of that group
csv_dir_path <- "~/Documents/GitHub/TDA-Microscopy-Pipeline/Discretized-images/25"

# recursively find CSV files within directory and return file-names in a list
files <- get_csvs(csv_dir_path)
```

## Compute persistence diagrams
*We use Delaunay complex filtration to compute persistence diagrams*

```{r}
compute_PDs(files, cell_types, csv_dir_path, group, saved_computations)
```

## Determine the max birth and max death among all data files
*This is needed to generate plots with the same scale and make sure that PLs have the same length*

```{r}
#BEFORE RUNNING THIS CODE BLOCK AND THE NEXT ONES, COMPUTE PERSISTENCE DIAGRAMS FOR ALL DATA GROUPS

max_values <- read.csv(concat_path(saved_computations, "max-values.csv"))

max_birth <- max(max_values$maxbirth)
max_death <- max(max_values$maxdeath)
```

## Plot persistence diagrams 

```{r}
save_plot <- TRUE #set FALSE if you don't want to save plots

plot_PDs(group, max_birth, max_death, saved_computations, save_plot)
```

## Plot representative cycles that persist (live) over a certain threshold

```{r}
#choose a persistence threshold
persistence_threshold <- 20 

#plot representative cycles with persistence above the chosen threshold
plot_representative_cycles(files, cell_types, csv_dir_path, persistence_threshold)
```

## Compute persistence landscapes (PLs) and automatically save them
*Since persistence computations might take long time to compute for a large data set, we automatically saving them*

```{r}
#choose a discretization step
discr_step <- 0.3

compute_PLs(group, max_birth, max_death, discr_step, saved_computations)
```

## Plot persistence landscapes 

```{r}
save_plot <- TRUE #set FALSE if you don't want to save plots

#choose a discretization step
discr_step <- 0.3

plot_PLs(group, max_birth, max_death, discr_step, saved_computations, save_plot)
```

## Compute the average persistence landscape

```{r}
compute_avgPL(group, max_birth, max_death, discr_step, saved_computations)
```

## Plot the average persistence landscape

```{r}
save_plot <- TRUE #set FALSE if you don't want to save plots

plot_avgPL(group, max_birth, max_death, discr_step, saved_computations, save_plot)
```

## Plot the difference in persistence landscapes of two data sets

```{r}
#BEFORE RUNNING THIS CODE BLOCK AND THE NEXT ONE, COMPUTE PERSISTENCE LANSCAPES AND AVERAGE PERSISTENCE LANDSCAPES FOR ANOTHER DATA GROUP

save_plot <- TRUE #set FALSE if you don't want to save plots

plot_avgPLs_difference(groups, max_birth, max_death, discr_step, saved_computations, save_plot)
```

## Perform a permutation test on persistence landscapes

```{r}
#number of permutations
num_repeats <- 10000

permutation_test_for_PLs(groups, saved_computations, num_repeats)
```

