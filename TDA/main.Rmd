# Topological Data Analysis of pattern formation of human induced pluripotent stem cell colonies

------------------------------------------------------------------------

#### Dependencies

*Install the following libraries before running the computations.*
*For plotting persistence diagrams and persistence landscape computations  we use 'tda-tools' package. Since it is not on CRAN, follow this link https://github.com/jjbouza/tda-tools for installation instructions.*

```{r}
install.packages(c("Rcpp", "TDA"))
```

------------------------------------------------------------------------

## Load libraries

```{r}
library("Rcpp")
library("TDA")
library("tdatools")
```
## Functions

*Pull generalized functions for TDA computations and for processing the CSV files from the discretization pipeline.*

```{r}
# get helper functions
source("utilities.R")
```

## Data parameters

```{r}
#Doxycycline concentrations
concentrations <- c(0,5,15,25)
#biological markers
cohorts <- c("Gata6","HA") 
nconcentrations <- length(concentrations)
ncohorts <- length(cohorts)
#number of images per concentration
nimages <- 15 
#number of patches per image
npatches <- 16 
#number of patches (samples) per concentration 
nsamples <- nimages*npatches 
#number of wells
nwells <- 3
#number of positions
npositions <- 5
```

## Load data

```{r} 
#specify the working directory path
working_dir_path <- "~/Documents/GitHub/TDA-Microscopy-Pipeline/TDA"

# specify location path of discretized CSVs
csv_dir_path <- "~/Documents/GitHub/TDA-Microscopy-Pipeline/tda-old/data/75"

files <- list()
for (j in cohorts){
  for (c in concentrations){ 
    for (w in 1:nwells){
      for (p in 1:npositions){
        files <- append(files, paste0(percentile,"/Nanog_", j,"/", p, "/", c,"/Nanog_",j, "_",c,"_", w, "_", p, "/merged.csv"))
      }
    }
  }
}
```

## Pick a cell type: R+G-, R-G+, R+G+, or R-G-

```{r}
#choose a cell type
cell_type <- "R+G-" 

if (cell_type == "R+G-"){
  type <- 1
} else if (cell_type == "R-G+"){
  type <- 10
} else if (cell_type == "R+G+"){
  type <- 11
} else if (cell_type == "R-G-"){
  type <- 0
}
```

## Computation of persistence diagrams for every patch
*Since persistence computations might take long time to compute for a large data set, we recommend saving them*

```{r}
#persistence homology computation
PH <- list()
for (i in 1:length(files)){
  print(sprintf("Processing file %s", files[[i]]))
  PH[[i]] <- list()
  for (k in 1:sqrt(npatches)){ #y-axis
    for (j in 1:sqrt(npatches)){ #x-axis
      all_cells <- read.csv(file=paste0(csv_dir_path,files[[i]]), header=TRUE)
      #every image is approximately 2850x2850 pixels
      #every patch is 712.5x712.5 pixels
      all_cells <- all_cells[which( (2850/sqrt(npatches))*(j-1) <= all_cells[,1] & all_cells[,1] < (2850/sqrt(npatches))*j & (2850/sqrt(npatches))*(k-1) <= all_cells[,2] & all_cells[,2] < (2850/sqrt(npatches))*k),]
      cells <- all_cells[ which(all_cells[,8]== type), ]               
      #compute persistence homology using Alpha complex which is also known as Delaunay complex
      PH[[i]][[j+(k-1)*sqrt(npatches)]] <-  alphaComplexDiag(cells[,1:2], maxdimension = 1, library = c("GUDHI", "Dionysus"), location = TRUE)
    }
  } 
}

#create a list of persistence diagrams
PDs <-list() 
max_birth <- list()
max_death <- list()
for (i in 1:length(files)){
  PDs[[i]] <-list()
  max_birth[[i]] <- list()
  max_death[[i]] <- list()
  for (k in 1:npatches){
    #convert from gudhi to tdatools diagram data structure
    PDs[[i]][[k]] <- gudhi2tdatools(PH[[i]][[k]]$diagram) 
    #birth and death values have been squared, so take the square root
    #homology in degree 0
    PDs[[i]][[k]]$pairs[[1]] <- sqrt(PDs[[i]][[k]]$pairs[[1]]) 
    #homology in degree 1
    PDs[[i]][[k]]$pairs[[2]] <- sqrt(PDs[[i]][[k]]$pairs[[2]])
    #max birth of 1-degree persistence diagrams 
    max_birth[[i]][[k]] <- max(PDs[[i]]$pairs[[2]][,1])
    #max death of 1-degree persistence diagrams 
    max_death[[i]][[k]] <- max(PDs[[i]]$pairs[[2]][,2])
  }
}

max_birth <- max(unlist(max_birth))
max_death <- max(unlist(max_death))

#free memory by removing some data from the workspace
remove(list=c("PH"))

#create a folder for saved computations
dir.create("saved_computations")

#save the list of persistence diagrams, the max birth and max death values
save_PD_filename <-  "persistence-diagrams.RData" 
save_PD_file_location <- paste0(working_dir_path, "/saved_computations/") 
save(PDs, max_birth, max_death, file=paste0(save_file_location,save_filename)) 
```

## Plot a persistence diagram

```{r}
par(pty="s") #makes a square plot 

#load saved persistence diagrams
load(paste0(save_PD_file_location,save_PD_filename))

max_radius <- max(max_birth, max_death)
for (i in 1:length(files)){
  plot_diagram(PDs[[i]]$pairs[[2]], max_radius)
}
```

## Compute persistence landscapes

```{r}

```

```{r}