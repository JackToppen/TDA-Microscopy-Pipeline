# Topological Data Analysis

------------------------------------------------------------------------

#### Dependencies

*Install the following libraries before running the TDA pipeline.*
*For plotting persistence diagrams and persistence landscape computations  we use 'tda-tools' package. Since it is not on CRAN, follow this link https://github.com/jjbouza/tda-tools for installation instructions.*

```{r}
install.packages(c("Rcpp", "TDA"))
```

------------------------------------------------------------------------
## Load libraries

```{r, include=FALSE}
library("Rcpp")
library("TDA")
library("tdatools")
```
## Functions

*Pull generalized functions for TDA computations and for processing the CSV files from the discretization pipeline.*

```{r}
# get helper functions
source("utilities.R")
```

## Load data

```{r}
#specify the working directory path
working_dir_path <- "~/Documents/GitHub/TDA-Microscopy-Pipeline/TDA"

# specify location path of discretized CSVs
csv_dir_path <- "~/Documents/GitHub/TDA-Microscopy-Pipeline/Discretized-images/25"


# recursively finds CSV files within directory and returns file-names in a list
files <- get_csvs(csv_dir_path)
#number of files
nfiles <- length(files)
```

## Compute persistence diagrams and save them
*We use Alpha filtration to compute persistence diagrams*
*Since persistence computations might take long time to compute for a large data set, we recommend saving them*

```{r}
#create a folder for the saved computations
dir.create("saved_computations")

#name a file where to store persistence diagrams
save_PD_filename <-  "persistence-diagrams.RData"

save_diagrams_list(files, csv_dir_path, save_PD_filename, paste0(working_dir_path, "/saved_computations/"))
```

## Plot persistence diagrams 
**The scale of all plots are the same and is determined by max birth and max death values**

```{r}
#load saved persistence diagrams
load(paste0(save_PD_file_location,save_PD_filename))

plot_diagrams_from_list(PDs, nfiles, max_birth, max_death)
```

## Plot representative cycles that persist (live) over a certain threshold

```{r}
#choose persistence threshold
persistence_threshold <- 20 

plot_representative_cycles(files, csv_dir_path, persistence_threshold)
```

## Compute persistence landscapes

```{r}
#choose a discretization step
discretization_step <- 0.4 

PLs <- landscapes_list(PDs, nfiles, max_birth, max_death, discretization_step)
```

## Plot persistence landscapes

```{r}
plot_landscapes_from_list(PLs, nfiles, max_birth, max_death)
```

## Plot the average PL

```{r}
plot_landscape(average_persistence_landscape(PLs, nfiles),(max_death+max_birth)/2 + 5, max_death/2 )
```

## Save each PL as a vector 
**Store the list of PLs as a matrix where rows correspond to PLs**

```{r}
#name a file where to store vectorized persistence landscapes
save_PL_filename <-  "vectorized-landscapes.RData"

# choose how many non-zero landscapes starting from the first one 
#you want to choose for further analysis (i.e. depth cap)
#Note that if this number is larger than the total number of non-zero landscapes than the total number of non-zero landscapes will be chosen as a depth cap
PL_depth_cap <- 30 

max_depth <- max_PL_depth(PLs, files)
PL_depth_cap <- min(PL_depth_cap, max_depth)
save_vectorized_landscapes(PLs, max_PL_depth, save_PL_filename, paste0(working_dir_path, "/saved_computations/"))
```

## Perform a permutation test on PLs
**Run the above code for two distinct groups that you would like to compare and use obtained vectorized PLs for permutation test**

```{r}
#load saved vectorized PLs of two groups
load(paste0(paste0(working_dir_path, "/saved_computations/"),save_PL_filename))
load(paste0(paste0(working_dir_path, "/saved_computations/"),save_PL_filename))

permutation_test(vectorized_PLs, vectorized_PLs)
```

