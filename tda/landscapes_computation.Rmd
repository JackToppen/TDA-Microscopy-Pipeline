---
  title: "Computation of persistence landscapes and vectorized persistence landscapes for a chosen type of cells"
  output:
  html_document:
  df_print: paged
---
Iryna Hartsock, Ashleigh Thomas, Alex Elchesen

```{r global_options, echo=FALSE}
knitr::opts_chunk$set(echo=FALSE)
# could also use warning=FALSE, message=FALSE
```
```{r setup}
knitr::opts_knit$set(root.dir="/Users/Iryna/Github/cell-patterning-project")
```
```{r libraries, message=FALSE}
library(tictoc)
library(tdatools)
library(viridisLite)
library(viridis)
source("./source/intro_tda.R")
source("./source/landscape_utilities.R")
source("config.R")
#source("persistence_computations.R")
```


```{r load-data}
#load_file <- saved_computation_filepath
#load(load_file)
#print(sprintf("computation README: %s", README))
print(sprintf("ncohorts=%i,nconcentrations=%i, nsamples=%i, percentile=%i, npatches=%i", ncohorts,  nconcentrations, nsamples, percentile, npatches))
```
```{r pick-cell-type-and-homology-degree}
type <- "double positive"   #red, green, double positive, double negative
n <- 2  #2 for homology in degree 1; 1 for homology in degree 0
```


```{r plot-persistence-diagrams}
if (type == "red"){
  PDs <- PDs_red
} else if (type == "green"){
  PDs <- PDs_green
} else if (type == "double positive"){
  PDs <- PDs_pos
} else if (type == "double negative"){
  PDs <- PDs_neg 
}

i <- 30 #pick image
k <- 1 # pick patch

par(pty="s", pch=20)
PDplot(PDs[[i]][[k]]$pairs[[n]])
title(main=sprintf("File %s, patch %1.0f, %s cells", i, k, type))
```

```{r compute-landscape-parameters}
dx <- 1
min_x <- 0
max_x <- 0
max_y <- 0

for (i in 1:length(data_filenames)){
  for (k in 1:npatches){
    for(j in 1: length(PDs[[i]][[k]]$pairs[[n]][,2])){
      if (PDs[[i]][[k]]$pairs[[n]][j,2] == Inf){
      PDs[[i]][[k]]$pairs[[n]][j,2] <- 0}
    }
    max_x <- max(max_x, PDs[[i]][[k]]$pairs[[n]][,2])
    max_y <- max(max_y,0.5*(PDs[[i]][[k]]$pairs[[n]][,2]-PDs[[i]][[k]]$pairs[[n]][,1]))
  }
}

landscape_length <- ceiling((max_x-min_x)/dx)

print(sprintf("dx=%f, min_x=%f, max_x=%f, max_y=%f, landscape_length=%i", dx, min_x, max_x, max_y, landscape_length))
```


```{r compute-landscapes-and-plot-them}
 
tic()
 
PLs <- list()
PL_depth_cap <- 30
max_PL_depth <- 0 # highest number of landscapes per diagram
min_PL_depth <- Inf # lowest number of landscapes per diagram
par(pty="s")
for (i in 1:length(data_filenames)){ # for each sample
   #print(i)
  PLs[[i]] <- list()
  for (k in 1:npatches){
    PLs[[i]][[k]] <- landscape0(PDs[[i]][[k]]$pairs[[n]], degree=1, exact=FALSE, dx=dx, min_x=min_x, max_x=max_x)
    #plot_landscape(PLs[[i]][[k]], max_y)
    #title(main=sprintf("%f file %s:", i, data_filenames[i]))
    depth <- dim(PLs[[i]][[k]]$getInternal())[1]
    max_PL_depth <- max(max_PL_depth, depth)
    if (depth > 1) { # nonzero landscape
      min_PL_depth <- min(min_PL_depth, depth)
    }
  }
}
PL_depth_cap <- min(max_PL_depth, PL_depth_cap)
print(sprintf("min_PL_depth=%i, max_PL_depth=%i. Setting PL_depth_cap to %i", min_PL_depth, max_PL_depth, PL_depth_cap))
toc()
```


```{r average-lanscapes-per-concentration}
par(pty="s")
PLs_list <- list()
for (j in 1:ncohorts){
  PLs_list[[j]] <- list()
  for (c in 1:nconcentrations){
    PLs_list[[j]][[c]] <- list()
    for (i in 1:nimages){
      for (k in 1:npatches){
        PLs_list[[j]][[c]] <- append(PLs_list[[j]][[c]],PLs[[nimages*(c-1)+(j-1)*nimages*nconcentrations+i]][[k]])
      }
    }
  }
}


PLs_avg <- list()
for (j in 1:ncohorts){
  if (j == 1){
    cohort <- "Gata6" #if Gata6
  } else {
    cohort <- "HA" #if HA
  }
  PLs_avg[[j]] <- list()
  for (c in 1:nconcentrations){
    if (c==1){
      concentration <- 0
    } else if (c==2){
      concentration <- 5
    } else if (c==3){
      concentration <- 15
    } else {concentration <- 25 }
    PL_sum <- PLs_list[[j]][[c]][[1]]
    for (i in 2:(nimages*npatches)){
      PL_sum <- PLsum(PL_sum, PLs_list[[j]][[c]][[i]])
    }
    PLs_avg[[j]][[c]]<- PLscale(1/(nimages*npatches), PL_sum)
    #plot_landscape_levels(PLs_avg[[j]][[c]], 1, 30, max_y)
    #title(main=sprintf("Average PL for %s concentration %1.0f",cohort,concentration)) 
  }
}
```


```{r plot-difference-in-average-landscapes-between-Gata6-and-HA}
for (c in 1:nconcentrations){
  par(pty="s")
   if (c==1){
      concentration <- 0
    } else if (c==2){
      concentration <- 5
    } else if (c==3){
      concentration <- 15
    } else {concentration <- 25 }
    #PLplot(PLsum(PLs_avg[[1]][[c]],PLscale(-1,PLs_avg[[2]][[c]])))
    plot_landscape_levels(PLsum(PLs_avg[[1]][[c]],PLscale(-1,PLs_avg[[2]][[c]])), 1, PL_depth_cap)
    title(main=sprintf("Gata6 vs HA concentration %1.0f",concentration)) 
}
```


```{r plot-difference-in-average-landscapes-between-concentrations}
for (j in 1:ncohorts){
  par(pty="s")
  if (j == 1){
    cohort <- "Gata6" #if Gata6
  } else {
    cohort <- "HA" #if HA
  }
  plot_landscape_levels(PLsum(PLs_avg[[j]][[1]],PLscale(-1,PLs_avg[[j]][[2]])), 1, PL_depth_cap)
  title(main=sprintf("%s concentration 0 vs 5",cohort)) 
  plot_landscape_levels(PLsum(PLs_avg[[j]][[1]],PLscale(-1,PLs_avg[[j]][[3]])), 1, PL_depth_cap)
  title(main=sprintf("%s concentration 0 vs 15",cohort)) 
  plot_landscape_levels(PLsum(PLs_avg[[j]][[1]],PLscale(-1,PLs_avg[[j]][[4]])), 1, PL_depth_cap)
  title(main=sprintf("%s concentration 0 vs 25",cohort)) 
  plot_landscape_levels(PLsum(PLs_avg[[j]][[2]],PLscale(-1,PLs_avg[[j]][[3]])), 1, PL_depth_cap)
  title(main=sprintf("%s concentration 5 vs 15",cohort)) 
  plot_landscape_levels(PLsum(PLs_avg[[j]][[2]],PLscale(-1,PLs_avg[[j]][[4]])), 1, PL_depth_cap)
  title(main=sprintf("%s concentration 5 vs 25",cohort)) 
  plot_landscape_levels(PLsum(PLs_avg[[j]][[3]],PLscale(-1,PLs_avg[[j]][[4]])), 1, PL_depth_cap)
  title(main=sprintf("%s concentration 15 vs 25",cohort)) 
}

```


```{r compute-average-landscapes-for-patches-and-plot-them}
PLs_avg <- list()
for (i in 1:length(data_filenames)){
  PL_sum <- PLs[[i]][[1]]
  for (k in 1:(npatches-1)){
    PL_sum <- PLsum(PL_sum, PLs[[i]][[k+1]])
  }
  PLs_avg[[i]] <- PLscale(1/npatches, PL_sum)
  #plot_landscape(PLs_avg[[i]], max_y)
  #title(main=sprintf("%f file %s:", i, data_filenames[i]))
}

```


```{r vectorize-landscapes}
vectorized_PLs <- vectorize_landscapes(PLs[[1]], PL_depth_cap)
for (i in 2:length(data_filenames)){
  v <- vectorize_landscapes(PLs[[i]], PL_depth_cap)
  vectorized_PLs <- rbind(vectorized_PLs, v)
}

if (type == "red"){
  vec_red <- vectorized_PLs
  PL_length_red <- landscape_length
} else if (type == "green"){
  vec_gr <- vectorized_PLs
  PL_length_gr <- landscape_length
} else if (type == "double positive"){
  vec_pos <- vectorized_PLs
  PL_length_pos <- landscape_length
} else{
  vec_neg <- vectorized_PLs
  PL_length_neg <- landscape_length
}
```

```{r }