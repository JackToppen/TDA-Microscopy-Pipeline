# TDA-Microscopy-Pipeline

## Install libraries

The following libraries help generate the discretized images.

```{r}
install.packages(c("ggplot2", "ggforce", "cowplot"))
```

## Normalize GFP/RFP expression

This code normalizes the expression values for GFP/RFP based on the cell specific DAPI nuclear stain expression.

```{r}
# pull functions from functions.R scripts
setwd("~/Documents/Research/TDA/R/TDA-Microscopy-Pipeline/Example/Discretize")
source("functions.R")

# set working directory to location of microscopy CSVs
setwd("~/Documents/Research/TDA/R/TDA-Microscopy-Pipeline/Example/Images")

# iterate over treatment groups
for (conc in c(0, 25)) {
  for (well in c(1, 2, 3)) {
    # get path to microscopy CSV file
    csv_path <- paste0("dox_", conc, "_well_", well, "/")

    # read the CSV, normalize the GFP/RFP, and save to new CSV
    df <- read.csv(paste0(csv_path, "intensities.csv"))
    df <- normalize(df)
    save_to_csv(df, paste0(csv_path, "normalized.csv"))
  }
}
```

## Generate discretized CSVs and images

Thresholds will be generated for each percentile and then applied to the data.

```{r}
# pull functions from functions.R scripts
setwd("~/Documents/Research/TDA/R/TDA-Microscopy-Pipeline/Example/Discretize")
source("functions.R")

# set working directory to location of microscopy CSVs
setwd("~/Documents/Research/TDA/R/TDA-Microscopy-Pipeline/Example/Images")

# hold actual values for dox concentrations and threshold percentiles
dox <- c(0, 25)
percs <- c(75, 80, 85, 90, 95)

# store distributions of cell types in a 2D list of 2x2 matrices
M <- list()
for (perc_index in c(1, 2, 3, 4, 5)) {
  M[[perc_index]] <- list()
  for (dox_index in c(1, 2)) {
    M[[perc_index]][[dox_index]] <- matrix(rep(0,4), ncol=2)
  }
}

# store location specific expression values for generating thresholds
gfp_values <- list()
rfp_values <- list()

# load baseline CSVs for generating thresholds
for (well in c(1, 2, 3)) {
  # directory path for baseline expression values
  dir_gfp <- paste0("dox_25_well_", well, "/")
  dir_rfp <- paste0("dox_0_well_", well, "/")
  
  # read the CSV to data frames
  gfp_df <- read.csv(paste0(dir_gfp, "normalized.csv"))
  rfp_df <- read.csv(paste0(dir_rfp, "normalized.csv"))
  
  # hold location specific expression values for GFP/RFP
  gfp_values[[well]] <- gfp_df[, 9]
  rfp_values[[well]] <- rfp_df[, 10]
}

for (perc_index in c(1, 2, 3, 4, 5)) {
  # get the percentile value
  perc <- percs[[perc_index]]
  
  # generate thresholds based percentile
  gfp_threshold <- gen_threshold(perc, gfp_values)
  rfp_threshold <- gen_threshold(perc, rfp_values)
  
  for (dox_index in c(1, 2)) {
    # get dox concentration value
    conc <- dox[[dox_index]]
      
    for (well in c(1, 2, 3)) {
      # get path to CSV file and file name
      csv_path <- paste0("dox_", conc, "_well_", well, "/")
      csv_name <- "normalized.csv"
      
      # read the CSV, discretize the GFP/RFP values, and assign colors
      df <- read.csv(paste0(csv_path, csv_name))
      df <- discretize(df, gfp_threshold, rfp_threshold)
      df <- assign_color(df, show_double_low=TRUE)
      
      # get/make directory for storing discretized images and CSVs
      disc_path <- paste0("Discretized/", perc, "/")
      dir.create(disc_path, recursive=TRUE, showWarnings=FALSE)
      
      # get image and CSV names and save
      image_name <- paste0("dox_", conc, "_well_", well, ".png")
      csv_name <- paste0("dox_", conc, "_well_", well, ".csv")
      save_image(df, paste0(disc_path, image_name))
      save_to_csv(df, paste0(disc_path, csv_name))
      
      # add to distribution table
      value <- gen_table(df, gfp_threshold, rfp_threshold)
      M[[perc_index]][[dox_index]] <- M[[perc_index]][[dox_index]] + value
    }
  }
}
```

## Show cell type distributions

Matrices containing the distribution of cell types based on the dox treatment and threshold percentile can be printed with the following code.

```{r}
# iterate over treatment groups
for (perc_index in c(1, 2, 3, 4, 5)) {
  for (dox_index in c(1, 2, 3, 4)) {
    # print a header based on the dox concentration and the threshold percentile
    cat("dox: ", conce[[dox_index]], ", percentile: ", dox[[perc_index]], "\n", sep="")
    
    # print the cell type distribution matrix
    print(M[[perc_index]][[dox_index]] / sum(M[[perc_index]][[dox_index]]))
    cat("\n")
  }
}
```
